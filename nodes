function convertTimeToStr(time) {
  return time < 10 ? '0' + time : time.toString();
}

function secToData(seconds) {
  const hours = Math.floor(seconds / 3600) % 24;
  const days = Math.floor(seconds / 86400);
  return `${convertTimeToStr(days)}å¤©${convertTimeToStr(hours)}å°æ—¶`;
}

function strOfSize(size) {
  const units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
  let level = 0;
  while (size >= 1024 && level < units.length - 1) {
      size /= 1024;
      level++;
  }
  return `${Math.floor(size)}.${Math.floor((size % 1) * 1000)} ${units[level]}`;
}

async function getFilenameFromUrl(url) {
  if (url.includes("sub?target=")) {
      const pattern = /url=([^&]*)/;
      const match = url.match(pattern);
      if (match) {
          const encodedUrl = match[1];
          const decodedUrl = decodeURIComponent(encodedUrl);
          return await getFilenameFromUrl(decodedUrl);  // é€’å½’è°ƒç”¨
      }
  } else if (url.includes("api/v1/client/subscribe?token")) {
      if (!url.includes("&flag=clash")) {
          url += "&flag=clash";
      }
      try {
          const response = await fetch(url);
          const contentDisposition = response.headers.get('Content-Disposition');
          if (contentDisposition) {
              const pattern = /filename\*=UTF-8''(.+)/;
              const result = contentDisposition.match(pattern);
              if (result) {
                  let filename = decodeURIComponent(result[1]);
                  filename = filename.replace("%20", " ").replace("%2B", "+");
                  return filename;
              }
          }
      } catch (error) {
          return '';
      }
  } else {
      return '';
  }
  return '';
}

async function subInfo(inputText) {
  const headers = { 'User-Agent': 'ClashforWindows/0.18.1' };
  const urlsList = inputText.match(/https?:\/\/[^\s]+/g);

  if (!urlsList || urlsList.length === 0) {
    return '<p>æœªæŸ¥æ‰¾åˆ°æœ‰æ•ˆè®¢é˜…é“¾æ¥</p>';
  } else if (urlsList.length > 150) {
    return '<p>è®¢é˜…é“¾æ¥è¿‡å¤šï¼Œå•æ¬¡å¯æŸ¥è¯¢æ•°é‡æœ€å¤§ä¸º150ï¼Œè¯·åˆç†ä½¿ç”¨</p>';
  }

  let finalOutput = `
    <table style="width: 100%; border-collapse: collapse; margin-top: 20px; text-align: left;">
      <thead>
        <tr style="background-color: #f2f2f2;">
          <th>è®¢é˜…é“¾æ¥ï¼ˆç‚¹å‡»å¤åˆ¶ï¼‰</th>
          <th>æœºåœºå</th>
          <th>å·²ç”¨ä¸Šè¡Œ</th>
          <th>å·²ç”¨ä¸‹è¡Œ</th>
          <th>å‰©ä½™</th>
          <th>æ€»å…±</th>
          <th>è¿‡æœŸæ—¶é—´</th>
          <th>å‰©ä½™æ—¶é—´</th>
        </tr>
      </thead>
      <tbody>
  `;

  // æ”¶é›†æ‰€æœ‰æŸ¥è¯¢çš„ Promise
  const promises = urlsList.map(async (subUrl) => {
    const filename = await getFilenameFromUrl(subUrl);
    try {
      const infoResponse = await fetch(subUrl, { headers });
      if (infoResponse.status === 200) {
        const info = infoResponse.headers.get('subscription-userinfo');
        const infoNum = info.match(/\d+/g);

        if (infoNum) {
          const currentTime = Math.floor(Date.now() / 1000);
          const airName = filename ? filename : 'æœªçŸ¥';
          let outputText = `
            <tr>
              <td>${subUrl}</td>
              <td>${airName}</td>
              <td>${strOfSize(Number(infoNum[0]))}</td>
              <td>${strOfSize(Number(infoNum[1]))}</td>
              <td>${strOfSize(Number(infoNum[2]) - Number(infoNum[1]) - Number(infoNum[0]))}</td>
              <td>${strOfSize(Number(infoNum[2]))}
          `;

          if (infoNum.length === 4) {
            const expiryDate = new Date((Number(infoNum[3]) + 28800) * 1000).toISOString().slice(0, 10);
            if (currentTime <= Number(infoNum[3])) {
              const timeLeft = Number(infoNum[3]) - currentTime;
              outputText += `
                <td>${expiryDate}</td>
                <td>${secToData(timeLeft)}</td>
              `;
            } else {
              outputText += `<td>${expiryDate}</td><td>å·²è¿‡æœŸ</td>`;
            }
          } else {
            outputText += `<td>æ²¡æœ‰è¯´æ˜</td><td>æ²¡æœ‰è¯´æ˜</td>`;
          }

          finalOutput += outputText + '</tr>';
        } else {
          finalOutput += `
            <tr>
              <td colspan="8">${subUrl}    æ— æµé‡ä¿¡æ¯</td>
            </tr>
          `;
        }
      } else {
        finalOutput += `
          <tr>
            <td colspan="8">${subUrl}    æ— æ³•è®¿é—®</td>
          </tr>
        `;
      }
    } catch (error) {
      finalOutput += `
        <tr>
          <td colspan="8">${subUrl}    è¿æ¥é”™è¯¯</td>
        </tr>
      `;
    }
  });

  await Promise.all(promises);

  finalOutput += '</tbody></table>';
  return finalOutput;
}


addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request));
});

async function handleRequest(request) {
  const url = new URL(request.url);

  if (request.method === 'POST' && url.pathname === '/api/query') {
      const requestBody = await request.json();
      const urlToCheck = requestBody.url;
      const result = await subInfo(urlToCheck);

      return new Response(result, {
          headers: { 'Content-Type': 'text/html;charset=UTF-8' }
      });
  }

  const html = `
  <!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>æ‰¹é‡æµé‡æŸ¥è¯¢</title>
      <style>
          body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; display: flex; flex-direction: column; justify-content: flex-start; align-items: stretch; height: 100vh; width: 100%; }
          h1 { color: #333; font-size: 28px; margin: 20px 0; padding: 10px; text-align: center; }
          .form-container { width: 100%; padding: 20px; background-color: white; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); box-sizing: border-box; margin-bottom: 20px; text-align: center; }
          
          /* è¾“å…¥æ¡† */
          textarea { 
            width: 80%; 
            min-height: 100px; 
            max-height: 200px; 
            padding: 10px; 
            margin: 10px 0; 
            border: 2px solid #ccc; 
            border-radius: 8px; 
            font-size: 16px; 
            resize: both; 
            overflow-y: auto;  /* å…è®¸å‚ç›´æ–¹å‘æ»šåŠ¨ */
            overflow-x: hidden; /* ç¦æ­¢æ°´å¹³æ–¹å‘æ»šåŠ¨ */
            box-sizing: border-box; 
          }
        
          button { 
              padding: 10px 20px; 
              background-color: #4CAF50; 
              color: white; 
              border: none; 
              border-radius: 5px; 
              cursor: pointer; 
              font-size: 16px; 
              transition: background-color 0.3s; 
              margin-top: 10px; 
          }
  
          button:hover { background-color: #45a049; }
  
          /* è¡¨æ ¼æ ·å¼ */
          table { 
              width: 100%; 
              border-collapse: collapse; 
              margin-top: 20px; 
              text-align: left; 
              table-layout: auto; /* è®©è¡¨æ ¼å®½åº¦æ ¹æ®å†…å®¹è‡ªåŠ¨è°ƒæ•´ */
          }
          th, td { 
              padding: 10px; 
              text-align: left; 
              border: 1px solid #ddd; 
              word-wrap: break-word;
              white-space: nowrap; /* ä¸æ¢è¡Œ */
              cursor: pointer; /* æ·»åŠ ç‚¹å‡»æ•ˆæœ */
          }
  
          th { 
              background-color: #f2f2f2; 
              color: #333; 
              resize: horizontal; /* åˆ—å¤´æ”¯æŒæ°´å¹³è°ƒæ•´ */
              overflow: hidden;
              min-width: 50px; /* è®¾ç½®æœ€å°å®½åº¦ */
          }
  
          td {
              overflow: hidden; /* è¶…å‡ºéƒ¨åˆ†éšè— */
              text-overflow: ellipsis; /* è¶…å‡ºéƒ¨åˆ†æ˜¾ç¤ºçœç•¥å· */
              max-width: 200px; /* è®¾ç½®æœ€å¤§å®½åº¦é™åˆ¶ */
          }
  
          td[contenteditable] {
              outline: none;
          }
  
          /* é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºå®Œæ•´å†…å®¹ */
          td:hover {
              overflow: visible;
              text-overflow: unset;
              background-color: #f9f9f9;
              cursor: pointer;
              white-space: normal; /* æ˜¾ç¤ºå®Œæ•´å†…å®¹ */
          }
  
          /* å“åº”å¼è®¾è®¡ */
          @media (max-width: 768px) { 
              body { padding: 10px; } 
              textarea { width: 100%; } 
              button { width: 100%; } 
          }
  
          /* å¤åˆ¶æˆåŠŸæç¤ºæ–‡æœ¬ */
          .copy-notice {
              display: none;
              position: fixed;
              bottom: 20px; /* è®©æç¤ºå‡ºç°åœ¨å±å¹•åº•éƒ¨ */
              left: 50%;
              transform: translateX(-50%);
              padding: 10px 20px;
              background-color: #4CAF50;
              color: white;
              border-radius: 5px;
              font-size: 16px;
              transition: opacity 0.5s ease-out;
          }
  
      </style>
  </head>
  <body>
  
      <h1>æ‰¹é‡æµé‡æŸ¥è¯¢</h1>
      <div id="buttons-container" style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
          <a href="https://t.me/helloworld_1024" target="_blank" style="flex: 0 1 auto; padding: 8px 12px; font-size: 14px; text-decoration: none; background-color: #007BFF; color: white; border-radius: 5px; text-align: center;">ä½ å¥½ä¸–ç•Œ - IOSé¢‘é“</a>
          <a href="https://t.me/CitizenScyu" target="_blank" style="flex: 0 1 auto; padding: 8px 12px; font-size: 14px; text-decoration: none; background-color: #007BFF; color: white; border-radius: 5px; text-align: center;">éº¦å…‹é˜¿è±¡ - å®‰å“é¢‘é“</a>
          <a href="https://t.me/hjfork" target="_blank" style="flex: 0 1 auto; padding: 8px 12px; font-size: 14px; text-decoration: none; background-color: #007BFF; color: white; border-radius: 5px; text-align: center;">æˆ‘æ˜¯åƒåœ¾ - å¤§äººé¢‘é“</a>
      </div>
      

  
      <div class="form-container">
          <form id="query-form" method="POST" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
              <textarea name="url" id="url-input" placeholder="è¾“å…¥è®¢é˜…é“¾æ¥"></textarea>
              <button type="submit">å¼€å§‹æŸ¥è¯¢</button>
          </form>
      </div>
  
      <h2>æŸ¥è¯¢ç»“æœï¼š</h2>
      <div id="result-container">
          <!-- æŸ¥è¯¢ç»“æœçš„è¡¨æ ¼å†…å®¹ä¼šåœ¨è¿™é‡Œå±•ç¤º -->
      </div>
  
      <div id="copy-notice" class="copy-notice">å†…å®¹å·²å¤åˆ¶ï¼<br>çœ‹ç‰‡é¢‘é“ @hsck666</div>
  
      <script>
            document.getElementById('query-form').addEventListener('submit', async function(event) {
              event.preventDefault();
              event.stopImmediatePropagation();
          
              const button = event.target.querySelector('button');
              const url = document.getElementById('url-input').value;
              button.disabled = true;
              button.innerHTML = "æ­£åœ¨æŸ¥è¯¢...";
              document.getElementById('result-container').innerHTML = '<a href="https://t.me/hjfork" target="_blank" style="text-align: center; display: block;">ğŸ‘‰<font color="#FF0000">ç‚¹è¿™é‡Œæ¢ç´¢ç»ä¸–åŠŸæ³•ï¼Œä¸å¯å¤–ä¼ </font></a>';
          
              try {
                  const result = await fetch('/api/query', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ url })
                  });
          
                  const resultText = await result.text();
                  document.getElementById('result-container').innerHTML = resultText;
              } catch (error) {
                  document.getElementById('result-container').innerHTML = 'æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åå†è¯•';
              } finally {
                  button.disabled = false;
                  button.innerHTML = "å¼€å§‹æŸ¥è¯¢";
              }
          });
          
  
          async function copyToClipboard(text) {
              try {
                  await navigator.clipboard.writeText(text);
                  showCopyNotice(text); 
              } catch (err) {
                  console.error('å¤åˆ¶å¤±è´¥:', err);
                  alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•');
              }
          }
  
          function showCopyNotice(text) {
              const notice = document.getElementById('copy-notice');
              notice.style.display = 'block';
              setTimeout(() => {
                  notice.style.opacity = '0'; // ä½¿ç”¨é€æ˜åº¦æ¸å˜
                  setTimeout(() => {
                      notice.style.display = 'none';
                      notice.style.opacity = '1'; // æ¢å¤é€æ˜åº¦
                  }, 500);
              }, 1500); // æ˜¾ç¤º1.5ç§’åæ¸éš
          }
  
          document.getElementById('result-container').addEventListener('click', function(event) {
              if (event.target.tagName === 'TD') {
                  const text = event.target.textContent.trim();
                  if (text) {
                      copyToClipboard(text);
                  }
              }
          });
      </script>
  
  </body>
  </html>
  
  `;
  
  return new Response(html, {
      headers: { 'Content-Type': 'text/html;charset=UTF-8' }
  });
}
